name: Examples Matrix Testing

on:
  push:
    branches: [master]
  pull_request:
    branches: [master, v1-dev]
  workflow_dispatch:

jobs:
  # Generate dynamic matrix from examples-config.json
  generate-matrix:
    name: Generate Examples Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Generate matrix from examples-config.json
        id: set-matrix
        run: |
          echo "Generating matrix from examples configuration..."
          matrix=$(jq -c '[.groups[] | .examples[] | select(.test_count > 0)]' examples/examples-config.json)
          echo "matrix=$matrix" >> $GITHUB_OUTPUT
          echo "Generated matrix:"
          echo "$matrix" | jq '.'

  # Test each example in parallel
  test-examples:
    name: Test ${{ matrix.example.name }}
    runs-on: ${{ matrix.os }}
    needs: generate-matrix
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        example: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}
    
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.0'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          go install github.com/fullstorydev/grpcurl/cmd/grpcurl@latest
          go install github.com/bavix/gripmock/v3@latest
          
          # Install bashly for script generation
          gem install bashly

      - name: Generate grpctestify
        run: |
          make generate
          
          mkdir -p ~/bin
          cp grpctestify.sh ~/bin/grpctestify
          chmod +x ~/bin/grpctestify
          echo "$HOME/bin" >> $GITHUB_PATH

      - name: Validate example structure
        run: |
          example_dir=$(find examples -name "${{ matrix.example.name }}" -type d)
          echo "Validating example: ${{ matrix.example.name }}"
          
          # Check required directories
          test -d "$example_dir" || (echo "Example directory not found: $example_dir" && exit 1)
          test -d "$example_dir/server" || (echo "Server directory not found: $example_dir/server" && exit 1)
          test -d "$example_dir/tests" || (echo "Tests directory not found: $example_dir/tests" && exit 1)
          
          # Check required files
          test -f "$example_dir/server/go.mod" || (echo "go.mod not found in server" && exit 1)
          test -f "$example_dir/server/main.go" || (echo "main.go not found in server" && exit 1)
          test -f "$example_dir/server/Makefile" || (echo "Makefile not found in server" && exit 1)
          
          # Count test files
          test_count=$(find "$example_dir/tests" -name "*.gctf" | wc -l)
          expected_count=${{ matrix.example.test_count }}
          
          if [ "$test_count" -eq "$expected_count" ]; then
            echo "Test count matches: $test_count tests found"
          else
            echo "Error: Test count mismatch: expected $expected_count, found $test_count"
            exit 1
          fi
          
          echo "Example structure validation passed"

      - name: Build gRPC server
        run: |
          set -euo pipefail
          example_dir=$(find examples -name "${{ matrix.example.name }}" -type d)
          echo "Building gRPC server for ${{ matrix.example.name }}"
          
          cd "$example_dir/server"
          make build

      - name: Start gRPC server in background
        run: |
          set -euo pipefail
          example_dir=$(find examples -name "${{ matrix.example.name }}" -type d)
          cd "$example_dir/server"
          
          echo "Starting gRPC server for ${{ matrix.example.name }} on port ${{ matrix.example.port }}"
          
          # Start server in background
          ./server &
          
          SERVER_PID=$!
          echo "SERVER_PID=$SERVER_PID" >> $GITHUB_ENV
          
          # Wait for server to start
          echo "Waiting for server to start..."
          for i in {1..30}; do
            if grpcurl -plaintext localhost:${{ matrix.example.port }} list >/dev/null 2>&1; then
              echo "Server ready on port ${{ matrix.example.port }}"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "Server failed to start within 30 seconds"
              kill $SERVER_PID
              exit 1
            fi
            sleep 1
          done

      - name: Validate server endpoints
        run: |
          echo "Validating server endpoints for ${{ matrix.example.name }}"
          
          # List available services
          echo "Available services:"
          grpcurl -plaintext localhost:${{ matrix.example.port }} list
          
          # Test health check if available
          if grpcurl -plaintext localhost:${{ matrix.example.port }} list | grep -q Health; then
            echo "Testing health check..."
            grpcurl -plaintext localhost:${{ matrix.example.port }} grpc.health.v1.Health/Check
          fi

      - name: Run gRPC tests
        run: |
          set -euo pipefail
          example_dir=$(find examples -name "${{ matrix.example.name }}" -type d)
          echo "Running gRPC tests for ${{ matrix.example.name }}"
          
          cd "$example_dir"
          
          # Set environment variables
          export GRPCTESTIFY_ADDRESS="localhost:${{ matrix.example.port }}"
          export GRPCTESTIFY_TIMEOUT=30
          export GRPCTESTIFY_VERBOSE=true
          
          # Run tests - fail fast on any error
          for test_file in tests/*.gctf; do
            if [ -f "$test_file" ]; then
              echo "Running test: $(basename "$test_file")"
              timeout 60 grpctestify "$test_file" --progress=dots
            fi
          done
          
          echo "All tests passed for ${{ matrix.example.name }}"

      - name: Cleanup
        if: always()
        run: |
          echo "Cleaning up..."
          if [ -n "${SERVER_PID:-}" ]; then
            echo "Stopping server (PID: $SERVER_PID)"
            kill $SERVER_PID 2>/dev/null || true
            pkill -f "localhost:${{ matrix.example.port }}" 2>/dev/null || true
          fi

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.example.name }}
          path: |
            examples/*/${{ matrix.example.name }}/tests/*.gctf
            examples/*/${{ matrix.example.name }}/server/*.log
          retention-days: 7
